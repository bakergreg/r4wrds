---
title: "Parameterized reports"
description: | 
   How to automate routine reporting
output: 
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE, purl=FALSE, message=FALSE}

library(knitr)
library(glue)
library(here)

```

::: {.obj}
**Learning objectives**

-   Extend functional programming skills to automate `.Rmd` reports  
-   Understand the available types of reports provided by `{rmarkdown}`  
:::

<br>

> "Your success in life will be determined largely by your ability to speak, your ability to write, and the quality of your ideas, in that order." â€” [Patrick Winston (1943-2019)](https://www.youtube.com/watch?v=Unzc731iCUY&t=37s)

Data science is the art of combining domain knowledge, statistics, math, programming, and visualization to find order and meaning in disorganized information. Communicating the results of your analyses, or ability to make data "speak", is of utmost importance. The modern day open source package ecosystem is full of powerful ways to give voice to our analyses.

Analyses typically lead to figures, tables, and a narrative interpreting these information. The [`{rmarkdown}`](https://rmarkdown.rstudio.com/) package provides `R` users with a standardized approach for turning `R` analyses into reports, documents, presentations, dashboards, and websites. In this module, we assume familiarity with `{rmarkdown}`, and extend the previous modules on iteration, functional programming, and reproducible workflows to demonstrate how to iterate over reports.

<aside>
Review the [introduction to `{rmarkdown}`](../intro/m_intro_Rmarkdown.html) if needed.
</aside>

According to [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/params-declare.html), some example use cases for creating a paramaterized report include:  

- Showing results for a specific geographic location.  
- Running a report that covers a specific time period.  
- Running a single analysis multiple times for different assumptions.  
- Controlling the behavior of knitr (e.g., specify if you want the code to be displayed or not).  

In this module, we will focus on example use case 1, and build paramaterized reports for a set of geographic locations. Throughout this course, we've been working with groundwater elevation data across California counties. Let's imagine that we want to generate a report on groundwater level trends for a set of counties.

Although the RStudio Interactive Development Environment (IDE) encourages knitting RMarkdown documents by clicking a button, we can also knit documents via: `rmarkdown::render()`. Iterating over `render()` is the key to scaling paramaterized reports. To iterate over R Markdown reports, we must first understand how to use `params`.  


```{r create-data, echo = FALSE, eval = FALSE}
# create a file to work with that includes only Sac, Yolo, and SJ counties
data_path <- here("data", "pgwl")
counties  <- c("Sacramento", "Yolo", "San Joaquin")
sep <- map_df(
  counties,
  ~f_wcr_import(
    county   = .x,
    files_in = list.files(data_path, full.names = TRUE)
  )
)
sep %>% write_rds(here("data", "sac_yolo_sj.rds"))
```


## `params`

A paramaterized .Rmd file takes a set of `params` (short for "parameters") in the YAML header, which are bound into a named list called `params` and accessed with code from within the .Rmd file with `params$<paramater-name>`. For example, consider the example YAML:

```
title: "My awesome paramaterized report"
output: html_document
params:
  start_date: 2021-01-01
  watershed: Yuba
  data: gwl_yuba.csv
```

In the code, we could then access the value `"2021-01-01"` with `params$start_date`. Similarly, `params$watershed` will equal `"Yuba"` and `params$data` will equal `"gwl_yuba.csv"`.


## Case study: automated reports

Let's apply `params` to our task: generate an `html_document` per county. To illustrate, we will use a simplified, pre-processed dataset of 3 counties (Sacramento, Yolo, and San Joaquin counties). Read in the data and take a look at the fields.

```{r read-counties}
library(tidyverse)
library(here)
library(sf)

# groundwater level data for Sacramento, Yolo, San Joaquin counties
gwl <- read_rds(here("data", "sac_yolo_sj.rds"))

gwl %>% 
  group_by(SITE_CODE) %>% 
  slice(1) %>% 
  plot()
```

We will iterate over the `COUNTY_NAME` to create three reports, one for each county. First, 












## In-line `R`

Within an `.Rmd` we can also insert `R` output in-line using the following syntax:

```{r, eval=FALSE, include=TRUE}
`r <function>`
```

So for instance we can write a string like: 

```{md, eval=FALSE, include=TRUE}
The mean of 1 and 3 is `r mean(c(1,3))`.
```

And when the document knits get: The mean of 1 and 3 is `r mean(c(1,3))`.




## Additional Resources

- [RMarkdown guide for paramaterized reports](https://bookdown.org/yihui/rmarkdown/parameterized-reports.html)  

<br>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<a href="m_reproducible_workflows.html" class="btn btn-secondary" style="float: left">Previous module:<br>Reproducible Workflows</a> <a href="m_advanced_spatial.html" class="btn btn-secondary" style="float: right;">Next module:<br>Advanced spatial</a>

